<!-- /index.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MathBridge Admin – Scarlet Bridge (Light Minimal)</title>

    <!-- LIBRARY IMPORTS -->
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
    />
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <!-- day.js (optional, for formatting dates) -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

    <!-- App stylesheet -->
    <base href="../">
    <link rel="stylesheet" href="assets/css/admin.css" />
</head>
<body>
<div class="app">
    <!-- Header -->
    <header class="app-header" role="banner">
        <div class="left">
            <button
                    class="icon-btn"
                    id="sidebarToggle"
                    aria-label="Thu gọn/Mở rộng sidebar"
                    title="Thu gọn/Mở rộng sidebar"
            >
                <i data-lucide="panel-left-close" aria-hidden="true"></i>
            </button>

            <a class="brand" href="#" aria-label="MathBridge Admin">
                <i data-lucide="bridge" class="brand-icon" aria-hidden="true"></i>
                <span class="brand-text">MathBridge Admin</span>
            </a>
        </div>

        <div class="center">
            <form class="search" role="search" aria-label="Tìm kiếm nhanh">
                <i data-lucide="search" aria-hidden="true"></i>
                <input
                        id="globalSearch"
                        type="search"
                        placeholder="Tìm học viên, gia sư, hợp đồng…"
                        aria-label="Ô tìm kiếm"
                        autocomplete="off"
                />
            </form>
        </div>

        <div class="right">
            <button class="btn brand" id="quickAddBtn" aria-haspopup="dialog" aria-controls="quickAddModal">
                <i data-lucide="plus" aria-hidden="true"></i>
                <span class="hide-sm">Thêm nhanh</span>
            </button>

            <div class="notif-wrapper">
                <button
                        class="icon-btn"
                        id="notifBtn"
                        aria-haspopup="true"
                        aria-expanded="false"
                        aria-controls="notifPopover"
                        aria-label="Thông báo"
                        title="Thông báo"
                >
                    <i data-lucide="bell" aria-hidden="true"></i>
                    <span class="badge" id="notifBadge">3</span>
                </button>

                <div class="popover" id="notifPopover" role="dialog" aria-modal="false" aria-label="Thông báo mới">
                    <div class="popover-header">
                        <strong>Thông báo</strong>
                        <button class="icon-btn sm" id="notifClose" aria-label="Đóng thông báo">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <ul class="notif-list" id="notifList">
                        <!-- filled by JS -->
                    </ul>
                    <div class="popover-footer"><a href="#" class="link">Xem tất cả</a></div>
                </div>
            </div>

            <div class="profile">
                <button class="profile-btn" id="profileBtn" aria-haspopup="true" aria-expanded="false">
                    <img class="avatar" src="https://i.pravatar.cc/40?img=13" alt="Avatar người dùng" />
                    <span class="hide-sm">Admin</span>
                    <i data-lucide="chevron-down" aria-hidden="true"></i>
                </button>
                <div class="menu" id="profileMenu" role="menu" aria-label="Menu hồ sơ">
                    <a href="#" role="menuitem"><i data-lucide="user"></i>Hồ sơ</a>
                    <a href="#" role="menuitem"><i data-lucide="settings"></i>Cài đặt</a>
                    <hr />
                    <a href="#" role="menuitem"><i data-lucide="log-out"></i>Đăng xuất</a>
                </div>
            </div>
        </div>
    </header>

    <div class="shell">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar" aria-label="Điều hướng chính">
            <nav class="nav">
                <a class="nav-item active" href="#" data-key="dashboard" title="Dashboard">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a class="nav-item" href="#" data-key="students" title="Học viên">
                    <i data-lucide="users"></i>
                    <span>Học viên</span>
                </a>
                <a class="nav-item" href="#" data-key="tutors" title="Gia sư">
                    <i data-lucide="graduation-cap"></i>
                    <span>Gia sư</span>
                </a>
                <a class="nav-item" href="#" data-key="programs" title="Chương trình">
                    <i data-lucide="book-open-text"></i>
                    <span>Chương trình</span>
                </a>
                <a class="nav-item" href="#" data-key="contracts" title="Hợp đồng &amp; Học phí">
                    <i data-lucide="file-text"></i>
                    <span>Hợp đồng &amp; Học phí</span>
                </a>
                <a class="nav-item" href="#" data-key="revenue" title="Doanh thu &amp; Báo cáo">
                    <i data-lucide="bar-chart-3"></i>
                    <span>Doanh thu &amp; Báo cáo</span>
                </a>
                <a class="nav-item" href="#" data-key="content" title="Nội dung học">
                    <i data-lucide="notebook-pen"></i>
                    <span>Nội dung học</span>
                </a>
                <a class="nav-item" href="#" data-key="crm" title="CRM/Leads">
                    <i data-lucide="messages-square"></i>
                    <span>CRM/Leads</span>
                </a>
                <a class="nav-item" href="#" data-key="settings" title="Cài đặt">
                    <i data-lucide="sliders-horizontal"></i>
                    <span>Cài đặt</span>
                </a>
                <a class="nav-item" href="#" data-key="audit" title="Lịch sử / Audit Logs">
                    <i data-lucide="clock-9"></i>
                    <span>Lịch sử / Audit Logs</span>
                </a>
            </nav>
        </aside>

        <!-- Main -->
        <main class="main" id="main" role="main">
            <!-- Sticky Filters toolbar (desktop/tablet) -->
            <section class="filters" id="filtersToolbar" aria-label="Bộ lọc">
                <div class="filters-row">
                    <div class="form-field">
                        <label for="gradeSelect">Lớp</label>
                        <select id="gradeSelect" aria-label="Chọn lớp">
                            <option value="all">Tất cả</option>
                            <option value="9">Lớp 9</option>
                            <option value="10">Lớp 10</option>
                            <option value="11">Lớp 11</option>
                            <option value="12">Lớp 12</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="goalSelect">Mục tiêu thi chứng chỉ</label>
                        <select id="goalSelect" aria-label="Chọn mục tiêu chứng chỉ">
                            <option value="all">Tất cả</option>
                            <option value="IGCSE">IGCSE</option>
                            <option value="A-Level">A-Level</option>
                            <option value="IB">IB</option>
                            <option value="AP">AP</option>
                            <option value="SAT">SAT</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="campusSelect">Cơ sở</label>
                        <select id="campusSelect" aria-label="Chọn cơ sở">
                            <option value="all">Tất cả</option>
                            <option value="1">Cơ sở 1</option>
                            <option value="2">Cơ sở 2</option>
                        </select>
                    </div>

                    <div class="form-field date">
                        <label for="dateFrom">Từ ngày</label>
                        <input id="dateFrom" type="date" aria-label="Từ ngày" />
                    </div>
                    <div class="form-field date">
                        <label for="dateTo">Đến ngày</label>
                        <input id="dateTo" type="date" aria-label="Đến ngày" />
                    </div>

                    <div class="filters-actions">
                        <button id="applyBtn" class="btn brand" aria-label="Áp dụng bộ lọc">
                            <i data-lucide="filter"></i><span>Áp dụng</span>
                        </button>
                        <button id="clearBtn" class="btn ghost" aria-label="Xoá bộ lọc">
                            <i data-lucide="x-circle"></i><span>Xoá lọc</span>
                        </button>
                    </div>

                    <button class="btn outline show-drawer" id="openDrawer" aria-controls="filtersDrawer" aria-haspopup="true">
                        <i data-lucide="filter"></i><span>Bộ lọc</span>
                    </button>
                </div>
            </section>

            <!-- KPI Cards -->
            <section class="kpi-grid" aria-label="Chỉ số tổng quan">
                <article class="card kpi" title="Số học viên đang hoạt động">
                    <div class="kpi-head">
                        <div class="kpi-icon">
                            <i data-lucide="users"></i>
                        </div>
                        <span class="kpi-label">Active Students</span>
                    </div>
                    <div class="kpi-main">
                        <div class="kpi-value" id="kpiStudents">—</div>
                        <span class="chip delta positive" id="kpiStudentsDelta">
                  <i data-lucide="arrow-up-right"></i><span>+4.2% so tháng trước</span>
                </span>
                    </div>
                    <div class="sparkline"></div>
                </article>

                <article class="card kpi" title="Tỉ lệ điểm danh tuần">
                    <div class="kpi-head">
                        <div class="kpi-icon">
                            <i data-lucide="calendar-check-2"></i>
                        </div>
                        <span class="kpi-label">Tỉ lệ điểm danh tuần</span>
                    </div>
                    <div class="kpi-main">
                        <div class="kpi-value" id="kpiAttendance">—</div>
                        <span class="chip delta neutral" id="kpiAttendanceDelta">
                  <i data-lucide="minus"></i><span>-0.3% vs tuần trước</span>
                </span>
                    </div>
                    <div class="sparkline"></div>
                </article>

                <article class="card kpi" title="Hóa đơn quá hạn">
                    <div class="kpi-head">
                        <div class="kpi-icon">
                            <i data-lucide="alert-triangle"></i>
                        </div>
                        <span class="kpi-label">Hóa đơn quá hạn</span>
                    </div>
                    <div class="kpi-main">
                        <div class="kpi-value" id="kpiOverdue">—</div>
                        <span class="chip delta negative" id="kpiOverdueDelta">
                  <i data-lucide="arrow-up-right"></i><span>+1.1% so tháng trước</span>
                </span>
                    </div>
                    <div class="sparkline"></div>
                </article>

                <article class="card kpi" title="Doanh thu tháng">
                    <div class="kpi-head">
                        <div class="kpi-icon">
                            <i data-lucide="dollar-sign"></i>
                        </div>
                        <span class="kpi-label">Doanh thu tháng</span>
                    </div>
                    <div class="kpi-main">
                        <div class="kpi-value" id="kpiRevenue">—</div>
                        <span class="chip delta positive" id="kpiRevenueDelta">
                  <i data-lucide="arrow-up-right"></i><span>+6.5% so tháng trước</span>
                </span>
                    </div>
                    <div class="sparkline"></div>
                </article>
            </section>

            <!-- Charts Row -->
            <section class="grid-2">
                <article class="card" id="revenueCard" aria-label="Biểu đồ doanh thu theo tháng">
                    <div class="card-head">
                        <h3>Doanh thu theo tháng</h3>
                        <div class="card-actions">
                            <button class="icon-btn sm" title="Tải xuống" aria-label="Tải xuống"><i data-lucide="download"></i></button>
                        </div>
                    </div>
                    <div class="skeleton-wrap"><div class="skeleton"></div></div>
                    <div class="card-body">
                        <canvas id="revenueChart" height="120" aria-label="Doanh thu theo tháng" role="img"></canvas>
                    </div>
                </article>

                <article class="card" id="enrollCard" aria-label="Ghi danh theo Chương trình">
                    <div class="card-head">
                        <h3>Ghi danh theo Chương trình</h3>
                        <div class="hint">Stacked (IGCSE / A-Level / IB / AP / SAT)</div>
                    </div>
                    <div class="skeleton-wrap"><div class="skeleton"></div></div>
                    <div class="card-body">
                        <canvas id="enrollChart" height="120" aria-label="Ghi danh theo chương trình" role="img"></canvas>
                    </div>
                </article>
            </section>

            <!-- Table -->
            <section class="card" id="invoiceCard" aria-label="Bảng Hóa đơn quá hạn">
                <div class="card-head">
                    <h3>Hóa đơn quá hạn</h3>
                    <div class="card-actions">
                        <label class="switch" title="Chế độ hiển thị bảng">
                            <input type="checkbox" id="densityToggle" aria-label="Chuyển chế độ density comfy/compact" />
                            <span>Compact</span>
                        </label>
                    </div>
                </div>

                <div class="skeleton-wrap"><div class="skeleton"></div></div>

                <div class="table-wrap">
                    <table class="table" id="invoiceTable">
                        <thead>
                        <tr>
                            <th>Tên</th>
                            <th>Liên quan</th>
                            <th>Trạng thái</th>
                            <th>Deadline</th>
                            <th class="text-right">Số tiền</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody><!-- rows injected by JS --></tbody>
                    </table>

                    <div class="empty" id="emptyState" hidden>
                        <i data-lucide="search-x"></i>
                        <p>Chưa có dữ liệu phù hợp — Hãy điều chỉnh bộ lọc.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Filter Drawer (mobile) -->
    <aside class="drawer" id="filtersDrawer" aria-label="Bộ lọc">
        <div class="drawer-head">
            <h3>Bộ lọc</h3>
            <button class="icon-btn" id="closeDrawer" aria-label="Đóng bộ lọc"><i data-lucide="x"></i></button>
        </div>
        <div class="drawer-body">
            <div class="form-field">
                <label for="gradeSelectDrawer">Lớp</label>
                <select id="gradeSelectDrawer">
                    <option value="all">Tất cả</option>
                    <option value="9">Lớp 9</option>
                    <option value="10">Lớp 10</option>
                    <option value="11">Lớp 11</option>
                    <option value="12">Lớp 12</option>
                </select>
            </div>

            <div class="form-field">
                <label for="goalSelectDrawer">Mục tiêu thi chứng chỉ</label>
                <select id="goalSelectDrawer">
                    <option value="all">Tất cả</option>
                    <option value="IGCSE">IGCSE</option>
                    <option value="A-Level">A-Level</option>
                    <option value="IB">IB</option>
                    <option value="AP">AP</option>
                    <option value="SAT">SAT</option>
                </select>
            </div>

            <div class="form-field">
                <label for="campusSelectDrawer">Cơ sở</label>
                <select id="campusSelectDrawer">
                    <option value="all">Tất cả</option>
                    <option value="1">Cơ sở 1</option>
                    <option value="2">Cơ sở 2</option>
                </select>
            </div>

            <div class="form-inline">
                <div class="form-field date">
                    <label for="dateFromDrawer">Từ ngày</label>
                    <input id="dateFromDrawer" type="date" />
                </div>
                <div class="form-field date">
                    <label for="dateToDrawer">Đến ngày</label>
                    <input id="dateToDrawer" type="date" />
                </div>
            </div>
        </div>
        <div class="drawer-foot">
            <button class="btn ghost" id="clearBtnDrawer"><i data-lucide="x-circle"></i><span>Xoá lọc</span></button>
            <button class="btn brand" id="applyBtnDrawer"><i data-lucide="filter"></i><span>Áp dụng</span></button>
        </div>
    </aside>

    <!-- Quick Add Modal -->
    <div class="modal" id="quickAddModal" role="dialog" aria-modal="true" aria-labelledby="quickAddTitle" hidden>
        <div class="modal-backdrop" id="quickAddBackdrop" tabindex="-1"></div>
        <div class="modal-panel" role="document">
            <div class="modal-head">
                <h3 id="quickAddTitle">Thêm nhanh</h3>
                <button class="icon-btn" id="quickAddClose" aria-label="Đóng"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="tabs" role="tablist" aria-label="Loại đối tượng">
                    <button class="tab active" data-tab="student" role="tab" aria-selected="true">Học viên</button>
                    <button class="tab" data-tab="tutor" role="tab" aria-selected="false">Gia sư</button>
                    <button class="tab" data-tab="contract" role="tab" aria-selected="false">Hợp đồng</button>
                </div>

                <form id="quickAddForm" class="form">
                    <div class="tab-panel" data-panel="student">
                        <div class="form-field">
                            <label>Họ tên</label>
                            <input type="text" placeholder="Nguyễn Văn A" />
                        </div>
                        <div class="form-field">
                            <label>Lớp</label>
                            <select>
                                <option>9</option><option>10</option><option>11</option><option>12</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>Chương trình</label>
                            <select>
                                <option>IGCSE</option><option>A-Level</option><option>IB</option><option>AP</option><option>SAT</option>
                            </select>
                        </div>
                    </div>

                    <div class="tab-panel" data-panel="tutor" hidden>
                        <div class="form-field">
                            <label>Họ tên gia sư</label>
                            <input type="text" placeholder="Trần Thị B" />
                        </div>
                        <div class="form-field">
                            <label>Môn</label>
                            <input type="text" placeholder="Toán, Lý…" />
                        </div>
                    </div>

                    <div class="tab-panel" data-panel="contract" hidden>
                        <div class="form-field">
                            <label>Mã hợp đồng</label>
                            <input type="text" placeholder="MB-HĐ-2025-001" />
                        </div>
                        <div class="form-field">
                            <label>Học viên</label>
                            <input type="text" placeholder="Nguyễn Văn A" />
                        </div>
                        <div class="form-field">
                            <label>Hạn thanh toán</label>
                            <input type="date" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-foot">
                <button class="btn ghost" id="quickAddCancel">Huỷ</button>
                <button class="btn brand" id="quickAddSubmit">Lưu</button>
            </div>
        </div>
    </div>

    <!-- Floating Help -->
    <button class="help-fab" title="Trợ giúp" aria-label="Trợ giúp">
        <i data-lucide="help-circle"></i>
    </button>
</div>

<script>
    // =========================
    // Scarlet Bridge Dashboard
    // =========================

    // ------- Mock Data -------
    // Students
    const students = [
      { id: 1, name: "Nguyễn Minh Anh", grade: 12, program: "A-Level", campus: 1, attendance: 92 },
      { id: 2, name: "Trần Gia Huy", grade: 11, program: "IB", campus: 2, attendance: 88 },
      { id: 3, name: "Lê Phương Linh", grade: 10, program: "IGCSE", campus: 1, attendance: 95 },
      { id: 4, name: "Phạm Đức Long", grade: 9, program: "AP", campus: 2, attendance: 90 },
      { id: 5, name: "Võ Khánh Vy", grade: 12, program: "SAT", campus: 1, attendance: 85 },
      { id: 6, name: "Đỗ Hoài Nam", grade: 11, program: "A-Level", campus: 1, attendance: 91 },
      { id: 7, name: "Bùi Thảo My", grade: 10, program: "IB", campus: 2, attendance: 96 },
      { id: 8, name: "Phan Quốc Bảo", grade: 12, program: "AP", campus: 2, attendance: 89 },
      { id: 9, name: "Hoàng Thuỳ Dung", grade: 9, program: "IGCSE", campus: 1, attendance: 94 },
      { id: 10, name: "Vũ Đức Thịnh", grade: 10, program: "SAT", campus: 1, attendance: 87 },
    ];

    // Programs (for reference)
    const programs = ["IGCSE", "A-Level", "IB", "AP", "SAT"];

    // Invoices (mock overdue and due soon)
    const invoices = [
      { id: "INV-001", studentId: 1, amount: 6200000, due: "2025-10-03", status: "overdue", contract: "MB-HĐ-2025-001" },
      { id: "INV-002", studentId: 3, amount: 4500000, due: "2025-10-01", status: "overdue", contract: "MB-HĐ-2025-002" },
      { id: "INV-003", studentId: 5, amount: 5200000, due: "2025-10-15", status: "due-soon", contract: "MB-HĐ-2025-003" },
      { id: "INV-004", studentId: 2, amount: 7100000, due: "2025-09-25", status: "overdue", contract: "MB-HĐ-2025-004" },
      { id: "INV-005", studentId: 7, amount: 3800000, due: "2025-10-20", status: "open", contract: "MB-HĐ-2025-005" },
    ];

    // Revenue per month (bar) + moving avg (line)
    const revenueMonthly = {
      labels: ["01","02","03","04","05","06","07","08","09","10","11","12"],
      values: [85, 92, 98, 110, 105, 123, 132, 127, 140, 151, 0, 0] // (đv: triệu)
    };

    // Notifications (mock)
    const notifications = [
      { icon: "alert-triangle", text: "3 hoá đơn quá hạn > 14 ngày", time: "15 phút trước" },
      { icon: "calendar", text: "Lớp A-Level K12 tối nay 19:00", time: "1 giờ trước" },
      { icon: "user-plus", text: "Thêm học viên mới: Hoàng Thuỳ Dung", time: "Hôm qua" },
      { icon: "badge-dollar-sign", text: "Đối soát doanh thu tháng 9 đã xong", time: "2 ngày trước" },
    ];

    // ------- State -------
    const state = {
      filters: {
        grade: "all",
        goal: "all",
        campus: "all",
        dateFrom: "",
        dateTo: ""
      },
      ui: {
        sidebarCollapsed: false,
        densityCompact: false,
        search: ""
      }
    };

    // ------- Utils -------
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
    const currency = (n) =>
      new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND", maximumFractionDigits: 0 }).format(n);

    // Simple debounce
    function debounce(fn, wait = 300) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(null, args), wait);
      };
    }

    function daysOverdue(dateStr) {
      const today = dayjs();
      const due = dayjs(dateStr);
      return Math.max(0, today.diff(due, "day"));
    }

    function chipStatus(inv) {
      const overdueDays = daysOverdue(inv.due);
      if (inv.status === "overdue") {
        if (overdueDays > 14) return { label: `Quá hạn ${overdueDays} ngày`, tone: "danger" };
        return { label: `Quá hạn ${overdueDays} ngày`, tone: "warning" };
      }
      if (inv.status === "due-soon") return { label: "Sắp đến hạn", tone: "warning" };
      if (inv.status === "open") return { label: "Đang mở", tone: "neutral" };
      return { label: "Đã thanh toán", tone: "success" };
    }

    function matchFilters(student, invDateStr) {
      const { grade, goal, campus, dateFrom, dateTo } = state.filters;
      if (grade !== "all" && Number(grade) !== student.grade) return false;
      if (goal !== "all" && goal !== student.program) return false;
      if (campus !== "all" && Number(campus) !== student.campus) return false;
      if (dateFrom && dayjs(invDateStr).isBefore(dayjs(dateFrom), "day")) return false;
      if (dateTo && dayjs(invDateStr).isAfter(dayjs(dateTo), "day")) return false;
      return true;
    }

    function matchSearch(str) {
      if (!state.ui.search) return true;
      const q = state.ui.search.toLowerCase();
      return String(str).toLowerCase().includes(q);
    }

    // ------- Sidebar Toggle -------
    function applySidebarCollapsed(collapsed) {
      const sidebar = $("#sidebar");
      const app = document.body;
      state.ui.sidebarCollapsed = collapsed;
      if (collapsed) {
        app.classList.add("sidebar-collapsed");
      } else {
        app.classList.remove("sidebar-collapsed");
      }
      localStorage.setItem("mb_sidebar_collapsed", String(collapsed));
    }

    // Auto collapse for <=1024
    function syncSidebarForViewport() {
      if (window.innerWidth <= 1024) {
        document.body.classList.add("sidebar-collapsed");
      } else {
        // restore from localStorage
        const saved = localStorage.getItem("mb_sidebar_collapsed") === "true";
        applySidebarCollapsed(saved);
      }
    }

    // ------- Charts -------
    let revenueChart, enrollChart;

    function initRevenueChart() {
      const ctx = $("#revenueChart");
      revenueChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: revenueMonthly.labels,
          datasets: [
            {
              type: "bar",
              label: "Doanh thu (triệu VND)",
              data: revenueMonthly.values,
              borderRadius: 8,
              backgroundColor: getComputedStyle(document.documentElement).getPropertyValue("--brand-100").trim(),
              borderColor: getComputedStyle(document.documentElement).getPropertyValue("--brand").trim(),
              borderWidth: 1,
              order: 2
            },
            {
              type: "line",
              label: "Trung bình trượt",
              data: movingAvg(revenueMonthly.values, 3),
              borderWidth: 2,
              tension: 0.35,
              pointRadius: 0,
              borderColor: getComputedStyle(document.documentElement).getPropertyValue("--brand-600").trim(),
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, labels: { boxWidth: 12 } },
            tooltip: { mode: "index", intersect: false }
          },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 20 } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function movingAvg(arr, w) {
      return arr.map((_, i) => {
        const s = Math.max(0, i - w + 1);
        const slice = arr.slice(s, i + 1);
        const sum = slice.reduce((a, b) => a + b, 0);
        return +(sum / slice.length).toFixed(1);
      });
    }

    function computeEnrollCounts(filteredStudents) {
      const dict = { "IGCSE": 0, "A-Level": 0, "IB": 0, "AP": 0, "SAT": 0 };
      for (const s of filteredStudents) dict[s.program] = (dict[s.program] || 0) + 1;
      return programs.map(p => dict[p] || 0);
    }

    function initEnrollChart() {
      const ctx = $("#enrollChart");
      enrollChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: programs,
          datasets: [
            {
              label: "Số ghi danh",
              data: computeEnrollCounts(students),
              backgroundColor: [
                "rgba(229,57,53,0.2)",
                "rgba(211,47,47,0.2)",
                "rgba(229,57,53,0.15)",
                "rgba(229,57,53,0.25)",
                "rgba(229,57,53,0.18)"
              ],
              borderColor: [
                "#E53935", "#D32F2F", "#E53935", "#E53935", "#D32F2F"
              ],
              borderWidth: 1,
              borderRadius: 8,
              stack: "programs"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { stacked: true, grid: { display: false } },
            y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    function updateEnrollChart() {
      const filtered = students.filter(s => matchFilters(s, dayjs().format("YYYY-MM-DD")));
      const counts = computeEnrollCounts(filtered);
      enrollChart.data.datasets[0].data = counts;
      enrollChart.update();
    }

    // ------- KPI -------
    function updateKpis() {
      const active = students.length;
      $("#kpiStudents").textContent = active;

      const avgAttend = Math.round(students.reduce((a, s) => a + s.attendance, 0) / students.length);
      $("#kpiAttendance").textContent = avgAttend + "%";

      const overdueCount = invoices.filter(i => i.status === "overdue").length;
      $("#kpiOverdue").textContent = overdueCount;

      const month10 = revenueMonthly.values[9] || 0;
      $("#kpiRevenue").textContent = currency(month10 * 1_000_000);
    }

    // ------- Table -------
    function buildInvoiceRow(inv) {
      const stu = students.find(s => s.id === inv.studentId);
      const chip = chipStatus(inv);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div class="cell-title">
            <span class="title">${inv.id} • ${inv.contract}</span>
            <span class="sub">${stu ? stu.name : "—"}</span>
          </div>
        </td>
        <td>
          <div class="rel">
            <span class="badge neutral" title="Đối tượng">Học viên</span>
            <span class="meta">${stu ? `Lớp ${stu.grade} • ${stu.program} • CS${stu.campus}` : ""}</span>
          </div>
        </td>
        <td><span class="badge ${chip.tone}" title="Trạng thái">${chip.label}</span></td>
        <td>${dayjs(inv.due).format("DD/MM/YYYY")}</td>
        <td class="text-right">${currency(inv.amount)}</td>
        <td class="actions">
          <button class="icon-btn sm" aria-label="Xem chi tiết" title="Xem"><i data-lucide="eye"></i></button>
          <button class="icon-btn sm" aria-label="Chỉnh sửa" title="Sửa"><i data-lucide="edit-3"></i></button>
          <button class="icon-btn sm" aria-label="Khác" title="Khác"><i data-lucide="more-horizontal"></i></button>
        </td>
      `;
      return tr;
    }

    function renderInvoiceTable() {
      const tbody = $("#invoiceTable tbody");
      tbody.innerHTML = "";

      // apply filters
      const rows = invoices
        .filter(inv => {
          const stu = students.find(s => s.id === inv.studentId);
          if (!stu) return false;
          // only show overdue & due-soon/open for visibility? Spec: table "Hóa đơn quá hạn" -> we primarily show overdue
          if (inv.status !== "overdue") return false;
          if (!matchFilters(stu, inv.due)) return false;

          // global search: search across invoice id, contract, student name
          const hay = `${inv.id} ${inv.contract} ${stu.name}`;
          return matchSearch(hay);
        });

      if (rows.length === 0) {
        $("#emptyState").hidden = false;
      } else {
        $("#emptyState").hidden = true;
        rows.forEach(inv => tbody.appendChild(buildInvoiceRow(inv)));
      }
      // Repaint icons inside table rows
      lucide.createIcons();
    }

    // ------- Loading Skeleton -------
    function withLoading(callback) {
      [$("#revenueCard"), $("#enrollCard"), $("#invoiceCard")].forEach(card => card.classList.add("loading"));
      setTimeout(() => {
        callback();
        [$("#revenueCard"), $("#enrollCard"), $("#invoiceCard")].forEach(card => card.classList.remove("loading"));
      }, 600); // fake delay
    }

    // ------- Filters Sync (Desktop/Mobile) -------
    function syncDrawerToToolbar() {
      $("#gradeSelectDrawer").value = $("#gradeSelect").value;
      $("#goalSelectDrawer").value = $("#goalSelect").value;
      $("#campusSelectDrawer").value = $("#campusSelect").value;
      $("#dateFromDrawer").value = $("#dateFrom").value;
      $("#dateToDrawer").value = $("#dateTo").value;
    }
    function syncToolbarToDrawer() {
      $("#gradeSelect").value = $("#gradeSelectDrawer").value;
      $("#goalSelect").value = $("#goalSelectDrawer").value;
      $("#campusSelect").value = $("#campusSelectDrawer").value;
      $("#dateFrom").value = $("#dateFromDrawer").value;
      $("#dateTo").value = $("#dateToDrawer").value;
    }

    function readFiltersFromToolbar() {
      state.filters.grade = $("#gradeSelect").value;
      state.filters.goal = $("#goalSelect").value;
      state.filters.campus = $("#campusSelect").value;
      state.filters.dateFrom = $("#dateFrom").value;
      state.filters.dateTo = $("#dateTo").value;
    }

    function applyFiltersAndRefresh() {
      readFiltersFromToolbar();
      withLoading(() => {
        updateEnrollChart();
        renderInvoiceTable();
      });
    }

    // Immediate update when grade/goal change (per requirement)
    function immediateFilterChange() {
      readFiltersFromToolbar();
      withLoading(() => {
        updateEnrollChart();
        renderInvoiceTable();
      });
    }

    function clearFilters() {
      $("#gradeSelect").value = "all";
      $("#goalSelect").value = "all";
      $("#campusSelect").value = "all";
      $("#dateFrom").value = "";
      $("#dateTo").value = "";
      applyFiltersAndRefresh();
    }

    // ------- Notifications -------
    function populateNotifications() {
      const list = $("#notifList");
      list.innerHTML = notifications.slice(0, 5).map(n => `
        <li class="notif-item">
          <i data-lucide="${n.icon}"></i>
          <div>
            <p>${n.text}</p>
            <span class="muted">${n.time}</span>
          </div>
        </li>
      `).join("");
    }

    function togglePopover(open) {
      const pop = $("#notifPopover");
      const btn = $("#notifBtn");
      if (open) {
        pop.classList.add("open");
        btn.setAttribute("aria-expanded", "true");
      } else {
        pop.classList.remove("open");
        btn.setAttribute("aria-expanded", "false");
      }
    }

    // ------- Quick Add Modal -------
    function openModal() {
      $("#quickAddModal").hidden = false;
      document.body.classList.add("has-modal");
    }
    function closeModal() {
      $("#quickAddModal").hidden = true;
      document.body.classList.remove("has-modal");
    }

    function switchTab(tabKey) {
      $$(".tab").forEach(b => {
        const active = b.dataset.tab === tabKey;
        b.classList.toggle("active", active);
        b.setAttribute("aria-selected", String(active));
      });
      $$(".tab-panel").forEach(p => p.hidden = (p.dataset.panel !== tabKey));
    }

    // ------- Density Toggle -------
    function applyDensity(compact) {
      const table = $("#invoiceTable");
      if (compact) table.classList.add("compact"); else table.classList.remove("compact");
      state.ui.densityCompact = compact;
      localStorage.setItem("mb_density_compact", String(compact));
    }

    // ------- Global Search -------
    const doSearch = debounce((value) => {
      state.ui.search = value;
      renderInvoiceTable();
    }, 250);

    // ------- Init -------
    document.addEventListener("DOMContentLoaded", () => {
      // Restore UI state
      state.ui.densityCompact = localStorage.getItem("mb_density_compact") === "true";
      $("#densityToggle").checked = state.ui.densityCompact;
      applyDensity(state.ui.densityCompact);

      const savedSidebar = localStorage.getItem("mb_sidebar_collapsed") === "true";
      applySidebarCollapsed(savedSidebar);
      syncSidebarForViewport();

      // Icons
      lucide.createIcons();

      // Notifications
      populateNotifications();

      // Charts
      initRevenueChart();
      initEnrollChart();

      // KPIs
      updateKpis();

      // First render
      renderInvoiceTable();

      // Events: Sidebar
      $("#sidebarToggle").addEventListener("click", () => applySidebarCollapsed(!state.ui.sidebarCollapsed));
      window.addEventListener("resize", syncSidebarForViewport);

      // Events: Filters toolbar immediate (grade/goal)
      $("#gradeSelect").addEventListener("change", immediateFilterChange);
      $("#goalSelect").addEventListener("change", immediateFilterChange);

      // Apply/Clear (includes campus & dates)
      $("#applyBtn").addEventListener("click", (e) => { e.preventDefault(); applyFiltersAndRefresh(); });
      $("#clearBtn").addEventListener("click", (e) => { e.preventDefault(); clearFilters(); });

      // Drawer open/close
      $("#openDrawer").addEventListener("click", () => {
        syncDrawerToToolbar();
        $("#filtersDrawer").classList.add("open");
      });
      $("#closeDrawer").addEventListener("click", () => $("#filtersDrawer").classList.remove("open"));
      $("#applyBtnDrawer").addEventListener("click", () => {
        syncToolbarToDrawer();
        $("#filtersDrawer").classList.remove("open");
        applyFiltersAndRefresh();
      });
      $("#clearBtnDrawer").addEventListener("click", () => {
        $("#gradeSelectDrawer").value = "all";
        $("#goalSelectDrawer").value = "all";
        $("#campusSelectDrawer").value = "all";
        $("#dateFromDrawer").value = "";
        $("#dateToDrawer").value = "";
      });

      // Density
      $("#densityToggle").addEventListener("change", (e) => applyDensity(e.target.checked));

      // Search
      $("#globalSearch").addEventListener("input", (e) => doSearch(e.target.value));

      // Notifications popover
      $("#notifBtn").addEventListener("click", () => {
        const open = !$("#notifPopover").classList.contains("open");
        togglePopover(open);
      });
      $("#notifClose").addEventListener("click", () => togglePopover(false));
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".notif-wrapper")) togglePopover(false);
      });

      // Profile menu
      $("#profileBtn").addEventListener("click", () => {
        $("#profileMenu").classList.toggle("open");
      });
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".profile")) $("#profileMenu").classList.remove("open");
      });

      // Quick Add modal
      $("#quickAddBtn").addEventListener("click", openModal);
      $("#quickAddClose").addEventListener("click", closeModal);
      $("#quickAddCancel").addEventListener("click", closeModal);
      $("#quickAddBackdrop").addEventListener("click", closeModal);
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

      $$(".tab").forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));

      // Fake submit
      $("#quickAddSubmit").addEventListener("click", () => {
        closeModal();
        alert("Đã lưu (mock)!");
      });
    });
</script>
</body>
</html>
