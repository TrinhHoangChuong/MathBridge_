<!-- file: pages/login.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω h·ªçc sinh ‚Äî MathBridge</title>
    <base href="../">

    <!-- Icon Set -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- CSS chung -->
    <link rel="stylesheet" href="assets/css/header.css"/>
    <link rel="stylesheet" href="assets/css/footer.css"/>
    <script src="assets/js/pages/header.pages.js" defer></script>
    <script src="./assets/js/utils/includePartials.js" defer></script>
    <script src="assets/js/config.js"></script>
    <!-- ensure centers api available for footer.page.js -->
    <script src="assets/js/api/centers.api.js"></script>

    <style>
        :root{
          --brand:#e11d48;
          --brand-100:rgba(225,29,72,.10);
          --navy:#0f172a;
          --text:#0f172a;
          --muted:#64748b;
          --border:rgba(15,23,42,.08);
          --radius:20px;
          --shadow:0 18px 35px rgba(15,23,42,.06);
          --error:#b91c1c;
          --error-bg:#fee2e2;
        }

        /* Shell */
        .auth-shell{
          min-height:calc(100vh - 140px);
          display:grid;
          place-items:center;
          background: radial-gradient(circle at top, rgba(225,29,72,.04), #fff);
          padding:32px 14px 48px;
        }

        /* Card */
        .auth-card{
          width:min(980px,100%);
          background:#fff;
          border:1px solid var(--border);
          border-radius:var(--radius);
          box-shadow:var(--shadow);
          padding:22px 20px 20px;
        }

        /* Header */
        .auth-head{
          display:flex;gap:.75rem;align-items:center;margin-bottom:1rem
        }
        .logo-mark{
          width:34px;height:34px;border-radius:14px;
          background:conic-gradient(from 220deg,#fff 0deg,#fee2e2 120deg,var(--brand) 240deg,#fda4af 360deg);
          box-shadow:0 8px 24px rgba(225,29,72,.18);
        }
        .auth-title{font-size:1.2rem;font-weight:700;color:var(--text);margin-bottom:4px;}
        .auth-sub{font-size:.86rem;color:var(--muted);}

        /* Tabs */
        .auth-tabs{display:flex;gap:8px;margin:14px 0 16px;}
        .tab-btn{
          flex:1;
          display:flex;align-items:center;justify-content:center;
          gap:.5rem;
          padding:10px 12px;
          border-radius:14px;
          border:1px solid var(--border);
          background:#fff;
          color:var(--text);
          font-weight:600;
          font-size:.92rem;
          cursor:pointer;
          transition:.18s ease;
        }
        .tab-btn:hover{background:#fafafa}
        .tab-btn[aria-selected="true"]{
          border-color:var(--brand);
          box-shadow:0 0 0 3px var(--brand-100);
          background:linear-gradient(180deg,#fff, #fff);
          color:var(--navy);
        }

        /* Panels */
        .panel{display:none;animation:fade .2s ease;}
        .panel.active{display:block;}
        @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

        /* Layout inside panel */
        .panel-grid{
          display:grid;gap:16px;
          grid-template-columns:1fr 1fr;
        }
        .panel-grid--single{grid-template-columns:1fr;}
        @media (max-width: 880px){
          .panel-grid{grid-template-columns:1fr;}
        }

        /* Fields */
        .mb-field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;}
        .mb-field label{font-weight:600;font-size:.83rem;color:var(--text);}
        .mb-field input,
        .mb-field select,
        .mb-field textarea{
          border:1px solid rgba(15,23,42,.1);
          border-radius:14px;
          padding:10px 12px;
          outline:none;
          font-size:.9rem;
          background:#fff;
        }
        .mb-field textarea{min-height:74px;resize:vertical}
        .mb-field input:focus,
        .mb-field select:focus,
        .mb-field textarea:focus{
          border-color:rgba(225,29,72,.5);
          box-shadow:0 0 0 3px var(--brand-100);
        }
        .auth-hint{font-size:.72rem;color:#94a3b8;margin-top:4px;}

        /* Error */
        .auth-error{
          background:var(--error-bg);
          color:var(--error);
          padding:8px 10px;
          border-radius:10px;
          font-size:.8rem;
          margin:8px 0 12px;
          display:none;
        }

        /* Buttons */
        .btn{
          display:inline-flex;align-items:center;justify-content:center;
          gap:.5rem;
          border-radius:14px;
          padding:10px 14px;
          font-weight:700;
          font-size:.95rem;
          border:1px solid transparent;
          cursor:pointer;
          transition:.18s ease;
        }
        .btn:disabled{opacity:.6;cursor:not-allowed}
        .btn--navy{background:var(--navy);color:#fff;}
        .btn--navy:hover{filter:brightness(1.05)}
        .btn--ghost{
          background:#fff;border-color:var(--border);color:var(--text);
        }
        .btn--ghost:hover{background:#fafafa}

        .actions{display:flex;gap:10px;align-items:center}
        .actions .btn{flex:1}

        main{padding-top:24px;}

        /* Credentials modal (scoped for this page) */
        .mb-modal{position:fixed;inset:0;display:none;z-index:2000}
        .mb-modal.is-open{display:flex;align-items:flex-start;justify-content:center}
        .mb-modal__backdrop{position:fixed;inset:0;background:rgba(15,23,42,.25);backdrop-filter:blur(2px)}
        .mb-modal__dialog{position:relative;background:#fff;border-radius:16px;margin:5.5rem 14px 2rem;max-width:520px;width:100%;box-shadow:0 25px 60px rgba(15,23,42,.12);padding:16px}
        .mb-modal__close{position:absolute;right:12px;top:12px;border:1px solid rgba(15,23,42,.08);background:#f8fafc;border-radius:999px;width:28px;height:28px;display:grid;place-items:center;cursor:pointer}
        .cred-header{text-align:center;padding:4px 6px 6px}
        .cred-title{font-weight:700;color:#0f172a;font-size:18px}
        .cred-sub{font-size:13px;color:#64748b}
        .cred-box{background:rgba(248,250,252,.6);border-radius:14px;margin:10px 0;padding:12px}
        .cred-field{margin:8px 0}
        .cred-field__row{display:flex;gap:8px;margin-top:6px}
        .cred-field__row input{flex:1;border:1px solid #e2e8f0;border-radius:10px;padding:8px}
        .cred-copy-btn{background:#fff;border:1px solid rgba(148,163,184,.35);border-radius:10px;padding:6px 10px;cursor:pointer}
        .cred-actions{display:flex;justify-content:flex-end;padding-top:6px}
        .btn--primary{background:var(--brand);color:#fff}

        /* Password toggle */
        .mb-field .password-wrapper{
          position:relative;
          display:flex;
          align-items:center;
          width:100%;
        }
        .mb-field .password-wrapper input{
          width:100%;
          padding-right:42px;
          box-sizing:border-box;
        }
        .mb-field .password-toggle{
          position:absolute;
          right:12px;
          top:50%;
          transform:translateY(-50%);
          background:none;
          border:none;
          cursor:pointer;
          padding:4px 8px;
          display:flex;
          align-items:center;
          justify-content:center;
          color:var(--muted);
          transition:color .15s ease;
          z-index:10;
          width:auto;
          height:auto;
          min-width:24px;
          min-height:24px;
        }
        .mb-field .password-toggle:hover{
          color:var(--text);
        }
        .mb-field .password-toggle:focus{
          outline:2px solid var(--brand-100);
          outline-offset:2px;
          border-radius:4px;
        }
        .mb-field .password-toggle i{
          font-size:18px;
          display:inline-block;
          line-height:1;
          width:18px;
          height:18px;
        }
    </style>
</head>
<body class="page-auth">
<header></header>

<main>
    <div class="auth-shell">
        <div class="auth-card" id="auth-card">
            <!-- Head -->
            <div class="auth-head">
                <span class="logo-mark" aria-hidden="true"></span>
                <div>
                    <h1 class="auth-title">Kh√¥ng gian h·ªçc sinh ‚Äî MathBridge</h1>
                    <p class="auth-sub">ƒêƒÉng nh·∫≠p ho·∫∑c t·∫°o t√†i kho·∫£n h·ªçc sinh m·ªõi.</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="auth-tabs" role="tablist" aria-label="Ch·ªçn ch·ª©c nƒÉng">
                <button id="tab-login" class="tab-btn" role="tab" aria-selected="true" aria-controls="panel-login" data-tab="login">
                    ƒêƒÉng nh·∫≠p
                </button>
                <button id="tab-register" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-register" data-tab="register">
                    ƒêƒÉng k√Ω
                </button>
            </div>

            <!-- LOGIN PANEL -->
            <section id="panel-login" class="panel active" role="tabpanel" aria-labelledby="tab-login">
                <p id="auth-error" class="auth-error" aria-live="polite"></p>

                <form id="mb-login-form" novalidate>
                    <div class="panel-grid panel-grid--single">
                        <div class="mb-field">
                            <label for="email">Email h·ªçc sinh</label>
                            <input id="email" name="email" type="email" required autocomplete="email"
                                   placeholder="vd: hs001@mathbridge.vn">
                        </div>

                        <div class="mb-field">
                            <label for="password">M·∫≠t kh·∫©u</label>
                            <div class="password-wrapper">
                                <input id="password" name="password" type="password" required autocomplete="current-password"
                                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                <button type="button" class="password-toggle" id="password-toggle" aria-label="Hi·ªÉn th·ªã m·∫≠t kh·∫©u">
                                    <i class="ph ph-eye" id="password-eye-icon"></i>
                                </button>
                            </div>
                            <p class="auth-hint">N·∫øu qu√™n m·∫≠t kh·∫©u, li√™n h·ªá qu·∫£n l√Ω trung t√¢m.</p>
                        </div>

                        <div class="actions">
                            <button type="submit" class="btn btn--navy" style="width:100%">
                                <span>ƒêƒÉng nh·∫≠p</span>
                            </button>
                            <button type="button" class="btn btn--ghost" data-switch="register" aria-label="Chuy·ªÉn sang ƒêƒÉng k√Ω">
                                T·∫°o t√†i kho·∫£n
                            </button>
                        </div>
                    </div>
                </form>
            </section>

            <!-- REGISTER PANEL (gi·ªëng logic ·ªü trang Course) -->
            <section id="panel-register" class="panel" role="tabpanel" aria-labelledby="tab-register" hidden>
                <p id="register-error" class="auth-error" aria-live="polite"></p>

                <form id="mb-register-form" novalidate>
                    <div class="panel-grid">
                        <!-- C·ªôt tr√°i -->
                        <div>
                            <div class="mb-field">
                                <label for="reg-fullname">H·ªç v√† t√™n</label>
                                <input id="reg-fullname" type="text" placeholder="vd: Tr·∫ßn Minh An" required>
                            </div>

                            <div class="mb-field">
                                <label for="reg-sdt">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input id="reg-sdt" type="tel" placeholder="vd: 0912345678" required inputmode="numeric">
                            </div>

                            <div class="mb-field">
                                <label for="reg-ngaysinh">Ng√†y sinh</label>
                                <input id="reg-ngaysinh" type="date" placeholder="dd/mm/yyyy">
                            </div>
                        </div>

                        <!-- C·ªôt ph·∫£i -->
                        <div>
                            <div class="mb-field">
                                <label for="reg-gioitinh">Gi·ªõi t√≠nh</label>
                                <select id="reg-gioitinh" required>
                                    <option value="" selected>‚Äî Ch·ªçn ‚Äî</option>
                                    <option value="1">Nam</option>
                                    <option value="0">N·ªØ</option>
                                </select>
                            </div>

                            <div class="mb-field">
                                <label for="reg-diachi">ƒê·ªãa ch·ªâ</label>
                                <textarea id="reg-diachi" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh" required></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="actions" style="margin-top:4px">
                        <button type="submit" class="btn btn--navy">
                            Ho√†n t·∫•t ƒëƒÉng k√Ω
                        </button>
                        <button type="button" class="btn btn--ghost" data-switch="login" aria-label="Chuy·ªÉn sang ƒêƒÉng nh·∫≠p">
                            T√¥i ƒë√£ c√≥ t√†i kho·∫£n
                        </button>
                    </div>
                </form>
            </section>
        </div>
    </div>
</main>

<footer></footer>

<!-- Credentials Modal -->
<div id="credentials-modal" class="mb-modal" aria-hidden="true">
  <div class="mb-modal__backdrop" data-close-credentials-modal></div>
  <div class="mb-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="cred-title">
    <button class="mb-modal__close" type="button" title="ƒê√≥ng" data-close-credentials-modal>√ó</button>
    <div class="cred-header">
      <div class="cred-emoji" aria-hidden="true">üéâ</div>
      <h3 id="cred-title" class="cred-title">Ch√∫c m·ª´ng b·∫°n ƒë√£ ƒëƒÉng k√Ω th√†nh c√¥ng!</h3>
      <p class="cred-sub">Vui l√≤ng <strong>l∆∞u l·∫°i</strong> th√¥ng tin ƒëƒÉng nh·∫≠p b√™n d∆∞·ªõi ƒë·ªÉ tr√°nh qu√™n.</p>
    </div>
    <div class="cred-box">
      <div class="cred-field">
        <label for="cred-email">üìß Email</label>
        <div class="cred-field__row">
          <input id="cred-email" type="text" readonly />
          <button type="button" class="cred-copy-btn" data-copy="email">Copy</button>
        </div>
      </div>
      <div class="cred-field">
        <label for="cred-password">üîë M·∫≠t kh·∫©u</label>
        <div class="cred-field__row">
          <input id="cred-password" type="text" readonly />
          <button type="button" class="cred-copy-btn" data-copy="password">Copy</button>
        </div>
      </div>
    </div>
    <div class="cred-actions">
      <button type="button" class="btn btn--primary" data-close-credentials-modal>‚úÖ ƒê√£ ghi nh·ªõ</button>
    </div>
  </div>
  </div>

<script>
    // Include header/footer partials
    document.addEventListener("DOMContentLoaded", function () {
      includePartials({ header: "partials/header.html", footer: "partials/footer.html" });

      const tabLogin = document.getElementById("tab-login");
      const tabRegister = document.getElementById("tab-register");
      const panelLogin = document.getElementById("panel-login");
      const panelRegister = document.getElementById("panel-register");

      function setTab(name){
        const isLogin = name !== "register";

        tabLogin.setAttribute("aria-selected", String(isLogin));
        tabRegister.setAttribute("aria-selected", String(!isLogin));

        panelLogin.classList.toggle("active", isLogin);
        panelRegister.classList.toggle("active", !isLogin);

        panelLogin.hidden = !isLogin;
        panelRegister.hidden = isLogin;

        // reset error boxes when switching
        const authErr = document.getElementById("auth-error");
        const regErr = document.getElementById("register-error");
        if (authErr){ authErr.textContent=""; authErr.style.display="none"; }
        if (regErr){ regErr.textContent=""; regErr.style.display="none"; }

        // focus first input in visible panel
        setTimeout(()=>{
          const first = (isLogin ? panelLogin : panelRegister).querySelector("input,select,textarea,button");
          first && first.focus && first.focus();
        }, 80);
      }

      // Tab button clicks
      tabLogin.addEventListener("click", ()=>setTab("login"));
      tabRegister.addEventListener("click", ()=>setTab("register"));

      // Secondary switches (ghost buttons)
      document.querySelectorAll("[data-switch]").forEach(btn=>{
        btn.addEventListener("click", ()=> setTab(btn.dataset.switch));
      });

      // Support deep link ?tab=register
      const url = new URL(window.location.href);
      if ((url.searchParams.get("tab")||"").toLowerCase()==="register"){
        setTab("register");
      } else {
        setTab("login");
      }

      // Password toggle functionality (gi·ªëng Courses page)
      const passwordInput = document.getElementById("password");
      const passwordToggle = document.getElementById("password-toggle");
      const passwordEyeIcon = document.getElementById("password-eye-icon");
      
      if (passwordInput && passwordToggle && passwordEyeIcon) {
        passwordToggle.addEventListener("click", function(e) {
          e.preventDefault();
          e.stopPropagation();
          const isPassword = passwordInput.type === "password";
          passwordInput.type = isPassword ? "text" : "password";
          passwordEyeIcon.className = isPassword ? "ph ph-eye-slash" : "ph ph-eye";
          passwordToggle.setAttribute("aria-label", isPassword ? "·∫®n m·∫≠t kh·∫©u" : "Hi·ªÉn th·ªã m·∫≠t kh·∫©u");
        });
      }
    });
</script>

<!-- trang footer ƒëang c·∫ßn -->
<script src="assets/js/pages/footer.page.js"></script>
<!-- API login (expose window.loginStudentApi) -->
<script src="assets/js/api/login.api.js"></script>
<!-- Logic submit (ƒëƒÉng nh·∫≠p) -->
<script src="assets/js/pages/login.page.js"></script>
<!-- Gom logic ƒëƒÉng k√Ω v√†o trang login -->
<script>
  (function(){
    document.addEventListener('DOMContentLoaded', function(){
      const form = document.getElementById('mb-register-form');
      const errBox = document.getElementById('register-error');
      if (!form) return;

      function showErr(msg){
        if (!errBox) return;
        errBox.textContent = msg || 'ƒêƒÉng k√Ω kh√¥ng th√†nh c√¥ng. Vui l√≤ng th·ª≠ l·∫°i.';
        errBox.style.display = 'block';
      }
      function hideErr(){
        if (!errBox) return;
        errBox.textContent = '';
        errBox.style.display = 'none';
      }

      function showCredentialsModal(email, password){
        const modal = document.getElementById('credentials-modal');
        if (!modal) return;
        const emailInput = document.getElementById('cred-email');
        const passwordInput = document.getElementById('cred-password');
        if (emailInput) emailInput.value = email || '';
        if (passwordInput) passwordInput.value = password || '';
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden','false');
        const goLogin = ()=>{
          modal.classList.remove('is-open');
          modal.setAttribute('aria-hidden','true');
          const loginTab = document.getElementById('tab-login');
          if (loginTab) loginTab.click();
          setTimeout(()=>{ document.getElementById('email')?.focus(); }, 80);
        };
        document.querySelectorAll('[data-close-credentials-modal]').forEach(el=>{
          el.addEventListener('click', goLogin);
        });
        // copy buttons
        document.querySelectorAll('.cred-copy-btn').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const type = btn.getAttribute('data-copy');
            const input = document.getElementById(type==='email'?'cred-email':'cred-password');
            if (input && input.value){ input.select(); document.execCommand('copy'); }
          });
        });
      }

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        hideErr();

        // Map form -> payload theo logic course.modal (DangKyLHRequest)
        const fullName = document.getElementById('reg-fullname')?.value?.trim();
        const sdt = document.getElementById('reg-sdt')?.value?.trim();
        const ngaySinh = document.getElementById('reg-ngaysinh')?.value ? new Date(document.getElementById('reg-ngaysinh').value) : null;
        const gioiTinhRaw = document.getElementById('reg-gioitinh')?.value;
        const diaChi = document.getElementById('reg-diachi')?.value?.trim();

        // Validate t·ªëi thi·ªÉu
        if (!fullName || !sdt || !gioiTinhRaw || !diaChi) {
          return showErr('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc.');
        }

        // Ch·ªçn API gi·ªëng Course: enroll/pending. N·∫øu kh√¥ng c√≥ courseId tr√™n URL,
        // t·ª± l·∫•y id l·ªõp ƒë·∫ßu ti√™n t·ª´ /api/public/course ƒë·ªÉ t·∫°o t√†i kho·∫£n gi·ªëng flow Course.
        const params = new URLSearchParams(window.location.search);
        let courseId = params.get('courseId');

        async function ensureCourseId() {
          if (courseId) return courseId;
          try {
            const res = await fetch((window.CONFIG?.BASE_URL||'') + '/api/public/course');
            const json = await res.json();
            const list = (json && json.data) || [];
            if (list.length > 0) return list[0].idLH;
          } catch(_) {}
          return null;
        }
        try {
          const pickedCourseId = await ensureCourseId();
          const url = (window.CONFIG?.BASE_URL||'') + (pickedCourseId ? '/api/public/enroll/pending' : '/api/public/auth/register');
          const body = pickedCourseId ? {
            hoTen: fullName,
            soDienThoai: sdt,
            ngaySinh: ngaySinh ? ngaySinh.toISOString() : null,
            gioiTinh: Number(gioiTinhRaw),
            diaChi: diaChi,
            courseId: pickedCourseId
          } : {
            email: null,
            password: null,
            sdt: sdt,
            gioiTinh: gioiTinhRaw === '1',
            ho: fullName.split(' ').slice(0,1).join(' '),
            tenDem: fullName.split(' ').slice(1,-1).join(' '),
            ten: fullName.split(' ').slice(-1).join(' '),
            diaChi: diaChi
          };

          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          const data = await res.json().catch(()=>({}));
          if (!res.ok || (data && data.success === false)) {
            return showErr((data && data.message) || 'ƒêƒÉng k√Ω th·∫•t b·∫°i.');
          }

          // N·∫øu l√† enroll/pending -> BE tr·∫£ email/password => hi·ªán modal credentials
          if (pickedCourseId && data && data.data) {
            const d = data.data;
            showCredentialsModal(d.email || '', d.password || '');
            return;
          }

          // Fallback: l∆∞u th√¥ng tin ƒëƒÉng nh·∫≠p n·∫øu backend tr·∫£ nh∆∞ login
          if (data) {
            try { localStorage.setItem('mb_auth', JSON.stringify(data)); } catch(_){ }
          }
          showCredentialsModal(data?.email || '', data?.password || '');
        } catch (err) {
          showErr('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.');
        }
      });
    });
  })();
  </script>
</body>
</html>
